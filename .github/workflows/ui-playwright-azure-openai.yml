name: UI Tests mit Playwright und Azure OpenAI

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  ui-tests:
    runs-on: ubuntu-latest

    env:
      APP_PORT: 8080

      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
      AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}

      TESTS_DIR: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # Optional: sicherstellen, dass das Projekt baut
      - name: Build Spring Boot app (compile/package, ohne Tests)
        run: |
          mvn -B -ntp clean package -DskipTests

      - name: Start Spring Boot app (via mvn spring-boot:run)
        run: |
          echo "Starte Spring Boot Anwendung via 'mvn spring-boot:run' ..."
          nohup mvn -DskipTests spring-boot:run > app.log 2>&1 &
          echo $! > app.pid

          echo "Warte, bis http://localhost:${APP_PORT}/ erreichbar ist..."
          for i in {1..30}; do
            if curl -sSf "http://localhost:${APP_PORT}/" > /dev/null; then
              echo "App ist erreichbar."
              exit 0
            fi
            echo "Noch nicht erreichbar, warte..."
            sleep 2
          done

          echo "App ist nach Timeout nicht erreichbar."
          echo "---- app.log ----"
          cat app.log || true
          exit 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright browsers
        run: |
          npx playwright install --with-deps

      - name: Generate Playwright UI/API tests with Azure OpenAI
        run: |
          python scripts/generate_ui_tests_with_azure_openai.py

      - name: Show Playwright test changes
        run: |
          echo "√Ñnderungen an Playwright-Tests:"
          git status --porcelain "$TESTS_DIR" || true
          git diff --stat "$TESTS_DIR" || true

      - name: Run Playwright tests
        run: |
          npx playwright test
        env:
          APP_BASE_URL: http://localhost:${APP_PORT}

      - name: Stop Spring Boot app
        if: always()
        run: |
          if [ -f app.pid ]; then
            echo "Beende App mit PID $(cat app.pid) ..."
            kill "$(cat app.pid)" || true
          fi

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: warn

      - name: Commit & push generated Playwright tests
        if: >
          success() &&
          github.event.pull_request.head.repo.full_name == github.repository
        env:
          TARGET_BRANCH: ${{ github.head_ref }}
          TESTS_DIR: ${{ env.TESTS_DIR }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "üîç Git-Status vor git add (Playwright-Tests):"
          git status --porcelain "$TESTS_DIR" || true

          # Alle √Ñnderungen & neue Dateien in tests/ aufnehmen
          git add -A "$TESTS_DIR"

          if git diff --cached --quiet; then
            echo "Keine neuen oder ge√§nderten Playwright-Testdateien. Kein Commit n√∂tig."
            exit 0
          fi

          echo "üìù Committe folgende √Ñnderungen:"
          git diff --cached --stat

          git commit -m "chore: update AI-generated UI/API tests (Playwright + Azure OpenAI)" || {
            echo "Nichts zu committen."
            exit 0
          }

          echo "üì• Hole ggf. entfernte √Ñnderungen (rebase): origin/${TARGET_BRANCH}"
          git pull --rebase origin "${TARGET_BRANCH}" || true

          echo "üì§ Pushe auf PR-Branch: ${TARGET_BRANCH}"
          git push origin HEAD:"${TARGET_BRANCH}" || {
            echo "‚ö†Ô∏è Konnte nicht pushen ‚Äì m√∂glicherweise Race Condition. Auto-Update der UI-Tests wurde in diesem Run √ºbersprungen."
            exit 0
          }
